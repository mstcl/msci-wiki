<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.553">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="NP">
<meta name="dcterms.date" content="2024-02-12">

<title>Dissipation Learning in Active Matter - Week 15</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<style>html{ scroll-behavior: smooth; }</style>


</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../activity_log/landing.html"> 
<span class="menu-text">Activity log</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../plots/landing.html"> 
<span class="menu-text">Plots</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../training/landing.html"> 
<span class="menu-text">CNN</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../writing/landing.html"> 
<span class="menu-text">Writing</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../misc.html"> 
<span class="menu-text">Misc</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
    <a href="https://github.com/mstcl/msci-wiki" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-git"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-full page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="99">
    <h2 id="toc-title">Content</h2>
   
  <ul>
  <li><a href="#tasks" id="toc-tasks" class="nav-link active" data-scroll-target="#tasks">Tasks</a></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary">Summary</a>
  <ul class="collapse">
  <li><a href="#basics-on-the-architecture-of-cnn" id="toc-basics-on-the-architecture-of-cnn" class="nav-link" data-scroll-target="#basics-on-the-architecture-of-cnn">Basics on the architecture of CNN</a></li>
  <li><a href="#classifying-our-modelproblem" id="toc-classifying-our-modelproblem" class="nav-link" data-scroll-target="#classifying-our-modelproblem">Classifying our model/problem</a></li>
  <li><a href="#initial-strategy" id="toc-initial-strategy" class="nav-link" data-scroll-target="#initial-strategy">Initial strategy</a></li>
  <li><a href="#model-a-trained-on-one-density-predicting-the-same-density." id="toc-model-a-trained-on-one-density-predicting-the-same-density." class="nav-link" data-scroll-target="#model-a-trained-on-one-density-predicting-the-same-density.">Model A trained on one density, predicting the same density.</a></li>
  <li><a href="#model-b-trained-on-one-density-predicting-the-same-density" id="toc-model-b-trained-on-one-density-predicting-the-same-density" class="nav-link" data-scroll-target="#model-b-trained-on-one-density-predicting-the-same-density">Model B, trained on one density, predicting the same density</a></li>
  <li><a href="#model-b-without-dropout-layer-trained-on-one-density-predicting-the-same-density" id="toc-model-b-without-dropout-layer-trained-on-one-density-predicting-the-same-density" class="nav-link" data-scroll-target="#model-b-without-dropout-layer-trained-on-one-density-predicting-the-same-density">Model B, without dropout layer, trained on one density, predicting the same density</a></li>
  <li><a href="#predicting-novel-densities" id="toc-predicting-novel-densities" class="nav-link" data-scroll-target="#predicting-novel-densities">Predicting novel densities</a></li>
  <li><a href="#model-a-on-phi0.25" id="toc-model-a-on-phi0.25" class="nav-link" data-scroll-target="#model-a-on-phi0.25">Model A on <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ϕ</mi><mo>=</mo><mn>0.25</mn></mrow><annotation encoding="application/x-tex">\phi=0.25</annotation></semantics></math></a></li>
  <li><a href="#model-b-on-phi0.25" id="toc-model-b-on-phi0.25" class="nav-link" data-scroll-target="#model-b-on-phi0.25">Model B on <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ϕ</mi><mo>=</mo><mn>0.25</mn></mrow><annotation encoding="application/x-tex">\phi=0.25</annotation></semantics></math></a></li>
  <li><a href="#model-b-without-dropout-layer-on-phi0.25" id="toc-model-b-without-dropout-layer-on-phi0.25" class="nav-link" data-scroll-target="#model-b-without-dropout-layer-on-phi0.25">Model B, without dropout layer, on <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ϕ</mi><mo>=</mo><mn>0.25</mn></mrow><annotation encoding="application/x-tex">\phi=0.25</annotation></semantics></math></a></li>
  <li><a href="#model-a-on-phi0.45" id="toc-model-a-on-phi0.45" class="nav-link" data-scroll-target="#model-a-on-phi0.45">Model A on <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ϕ</mi><mo>=</mo><mn>0.45</mn></mrow><annotation encoding="application/x-tex">\phi=0.45</annotation></semantics></math></a></li>
  <li><a href="#model-b-on-phi0.45" id="toc-model-b-on-phi0.45" class="nav-link" data-scroll-target="#model-b-on-phi0.45">Model B on <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ϕ</mi><mo>=</mo><mn>0.45</mn></mrow><annotation encoding="application/x-tex">\phi=0.45</annotation></semantics></math></a></li>
  <li><a href="#model-b-without-dropout-layer-on-phi0.45" id="toc-model-b-without-dropout-layer-on-phi0.45" class="nav-link" data-scroll-target="#model-b-without-dropout-layer-on-phi0.45">Model B, without dropout layer, on <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ϕ</mi><mo>=</mo><mn>0.45</mn></mrow><annotation encoding="application/x-tex">\phi=0.45</annotation></semantics></math></a></li>
  <li><a href="#comparing-model-a-to-model-b" id="toc-comparing-model-a-to-model-b" class="nav-link" data-scroll-target="#comparing-model-a-to-model-b">Comparing Model A to Model B</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content column-page-left" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Week 15</h1>
</div>



<div class="quarto-title-meta column-page-left">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>NP </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">February 12, 2024</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="tasks" class="level2">
<h2 class="anchored" data-anchor-id="tasks">Tasks</h2>
<ul class="task-list">
<li><label><input type="checkbox" checked="">Play with different layers in Keras and train some models.</label></li>
<li><label><input type="checkbox" checked="">Make some utility functions to reuse for training in <code>training_utils.py</code> (basically data preprocessing stuff).</label></li>
<li><label><input type="checkbox" checked="">Research CNNs.</label></li>
</ul>
</section>
<section id="summary" class="level2">
<h2 class="anchored" data-anchor-id="summary">Summary</h2>
<p>We are currently doing this on our personal machines as doing interactive mode is not possible on BluePebble (unclear about BlueCrystal). Playing with the CNNs on a local notebook is the best method for now to be able to prototype quickly.</p>
<section id="basics-on-the-architecture-of-cnn" class="level3">
<h3 class="anchored" data-anchor-id="basics-on-the-architecture-of-cnn">Basics on the architecture of CNN</h3>
<p>We feed our snapshots in, but to represent it as a tensor. Our snapshot has one channel depth, so the tensor shape is <code>(128,128,1)</code>.</p>
<p>We start out with the <strong>convolutional layer</strong>. This layer performs a convolution, scanning the input with a number of filters with a smaller size than the input image itself, the size of the filter is determined by the kernel size. And the output of shape of the convolutional layer is of shape <code>(128,128,N)</code> where <code>N</code> is the number of filters applied.</p>
<ul>
<li>Kernel size <code>(x,y)</code> is the window size that scans the image at each iteration.</li>
<li>Stride <code>(x,y)</code> is the step length to jump at each iteration.</li>
<li>Each filter produces a feature map, every filter added captures more complex patterns.</li>
<li>We increase filter size with subsequent layers to capture more more combinations.</li>
</ul>
<p>A <strong>flatten layer</strong> will turn the input shape <code>(x,y,c)</code> into <code>(x*y*c)</code>, i.e.&nbsp;a 1D vector.</p>
<p>A <strong>dense layer</strong> (or fully-connected), map all input neurons to output neurons. It takes in the number of units (neurons) and turn the input shape <code>(x,y,c)</code> into <code>(x,y,units)</code>.</p>
<ul>
<li>Linear activation is pass-through (does nothing).</li>
</ul>
<p>A <strong>pooling layer</strong> reduces dimensions of the feature maps, which reduces the number of parameters. We have max pooling and average pooling (max takes maximum value from the kernel window and average takes the mean).</p>
<p>A <strong>dropout layer</strong> randomly drops a fraction (the input parameter) of the input units to 0.</p>
<p>A <strong>batch normalization</strong> layer normalizes the output. This helps with training speed.</p>
<p>To help reduce overfitting:</p>
<ul>
<li>Increase training data</li>
<li>Use pooling, batch normalization, and dropout layers</li>
</ul>
</section>
<section id="classifying-our-modelproblem" class="level3">
<h3 class="anchored" data-anchor-id="classifying-our-modelproblem">Classifying our model/problem</h3>
<p>For this week, we start building the network. Our network is a regression problem, predicting a continuous parameter, our tumbling rate <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>α</mi><annotation encoding="application/x-tex">\alpha</annotation></semantics></math>.</p>
<p>For this to work, we choose a loss function such as mean absolute error and mean squared error. We picked mean absolute error for now. This means the neural network will try and optimize this function, and this metric will be a good indication of how well we’ve designed the architecture and everything surrounding it.</p>
<p>The equation for mean absolute error is:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>δ</mi><mo>=</mo><mfrac><mrow><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>0</mn></mrow><mi>N</mi></munderover><mrow><mo stretchy="true" form="prefix">|</mo><msub><mi>y</mi><mi>i</mi></msub><mo>−</mo><msub><mi>y</mi><mi>p</mi></msub><mo stretchy="true" form="postfix">|</mo></mrow></mrow><mi>N</mi></mfrac><mo>,</mo></mrow><annotation encoding="application/x-tex">
\delta = \frac{\sum_{i=0}^{N}|y_i - y_p|}{N},
</annotation></semantics></math></p>
<p>where <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>y</mi><mi>i</mi></msub><annotation encoding="application/x-tex">y_i</annotation></semantics></math> is the actual value and <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>y</mi><mi>p</mi></msub><annotation encoding="application/x-tex">y_p</annotation></semantics></math> is the predicted value.</p>
<p>Effectively, we want the model to minimise the mean absolute error (MAE from now on). From some precursor research, regression done on non-image data typically use only fully-connected layers. We have image data that we wish to apply convolution on, therefore we have to combine both.</p>
<p>The input is an image, but we have to output a 1D vector that maps to predictions for one parameter (continuous). To do this, we apply <code>Flatten()</code> and <code>Dense(1, activation="linear")</code> at the end.</p>
</section>
<section id="initial-strategy" class="level3">
<h3 class="anchored" data-anchor-id="initial-strategy">Initial strategy</h3>
<p>We begin with a simple model with one <code>Conv2D</code> layer, and train it on data that is not experimental-like, i.e.&nbsp;orientation is still encoded as colours. We shall later consider training without this, or seeing the effect without it:</p>
<section id="a-simple-network-to-start-with-model-a" class="level4">
<h4 class="anchored" data-anchor-id="a-simple-network-to-start-with-model-a">A simple network to start with: Model A</h4>
<p>I used this in the single density notebook as the “basic” network:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1"></a>model <span class="op">=</span> Sequential()</span>
<span id="cb1-2"><a href="#cb1-2"></a></span>
<span id="cb1-3"><a href="#cb1-3"></a>model.add(</span>
<span id="cb1-4"><a href="#cb1-4"></a>    Conv2D(</span>
<span id="cb1-5"><a href="#cb1-5"></a>        filters<span class="op">=</span><span class="dv">3</span>,</span>
<span id="cb1-6"><a href="#cb1-6"></a>        kernel_size<span class="op">=</span>(<span class="dv">3</span>, <span class="dv">3</span>),</span>
<span id="cb1-7"><a href="#cb1-7"></a>        padding<span class="op">=</span><span class="st">"same"</span>,</span>
<span id="cb1-8"><a href="#cb1-8"></a>        strides<span class="op">=</span>(<span class="dv">3</span>, <span class="dv">3</span>),</span>
<span id="cb1-9"><a href="#cb1-9"></a>        activation<span class="op">=</span><span class="st">"relu"</span>,</span>
<span id="cb1-10"><a href="#cb1-10"></a>        input_shape<span class="op">=</span>shape,</span>
<span id="cb1-11"><a href="#cb1-11"></a>    )</span>
<span id="cb1-12"><a href="#cb1-12"></a>)</span>
<span id="cb1-13"><a href="#cb1-13"></a>model.add(Flatten())</span>
<span id="cb1-14"><a href="#cb1-14"></a>model.add(Dense(units<span class="op">=</span><span class="dv">1</span>, activation<span class="op">=</span><span class="st">"linear"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We compare this with a slightly more complicated one.</p>
</section>
<section id="a-more-complicated-network-model-b" class="level4">
<h4 class="anchored" data-anchor-id="a-more-complicated-network-model-b">A more complicated network: Model B</h4>
<p>Based on <a href="https://scribe.rip/@msgold/predicting-images-with-a-cnn-90a25a9e4509">this blog post</a>, where they work on a classification problem, so we need to be careful with the output<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1"></a>model <span class="op">=</span> Sequential()</span>
<span id="cb2-2"><a href="#cb2-2"></a></span>
<span id="cb2-3"><a href="#cb2-3"></a>model.add(</span>
<span id="cb2-4"><a href="#cb2-4"></a>    Conv2D(</span>
<span id="cb2-5"><a href="#cb2-5"></a>        filters<span class="op">=</span><span class="dv">3</span>,</span>
<span id="cb2-6"><a href="#cb2-6"></a>        kernel_size<span class="op">=</span>(<span class="dv">3</span>, <span class="dv">3</span>),</span>
<span id="cb2-7"><a href="#cb2-7"></a>        padding<span class="op">=</span><span class="st">"same"</span>,</span>
<span id="cb2-8"><a href="#cb2-8"></a>        strides<span class="op">=</span>(<span class="dv">3</span>, <span class="dv">3</span>),</span>
<span id="cb2-9"><a href="#cb2-9"></a>        activation<span class="op">=</span><span class="st">"relu"</span>,</span>
<span id="cb2-10"><a href="#cb2-10"></a>        input_shape<span class="op">=</span>shape,</span>
<span id="cb2-11"><a href="#cb2-11"></a>    )</span>
<span id="cb2-12"><a href="#cb2-12"></a>)</span>
<span id="cb2-13"><a href="#cb2-13"></a>model.add(BatchNormalization())</span>
<span id="cb2-14"><a href="#cb2-14"></a>model.add(Conv2D(filters<span class="op">=</span><span class="dv">3</span>, kernel_size<span class="op">=</span>(<span class="dv">3</span>, <span class="dv">3</span>), padding<span class="op">=</span><span class="st">"same"</span>))</span>
<span id="cb2-15"><a href="#cb2-15"></a>model.add(BatchNormalization())</span>
<span id="cb2-16"><a href="#cb2-16"></a></span>
<span id="cb2-17"><a href="#cb2-17"></a>model.add(MaxPooling2D(pool_size<span class="op">=</span>(<span class="dv">3</span>, <span class="dv">3</span>)))</span>
<span id="cb2-18"><a href="#cb2-18"></a></span>
<span id="cb2-19"><a href="#cb2-19"></a>model.add(Conv2D(filters<span class="op">=</span><span class="dv">6</span>, kernel_size<span class="op">=</span>(<span class="dv">3</span>, <span class="dv">3</span>), padding<span class="op">=</span><span class="st">"same"</span>))</span>
<span id="cb2-20"><a href="#cb2-20"></a>model.add(BatchNormalization())</span>
<span id="cb2-21"><a href="#cb2-21"></a></span>
<span id="cb2-22"><a href="#cb2-22"></a>model.add(Conv2D(filters<span class="op">=</span><span class="dv">6</span>, kernel_size<span class="op">=</span>(<span class="dv">3</span>, <span class="dv">3</span>), padding<span class="op">=</span><span class="st">"same"</span>))</span>
<span id="cb2-23"><a href="#cb2-23"></a>model.add(BatchNormalization())</span>
<span id="cb2-24"><a href="#cb2-24"></a></span>
<span id="cb2-25"><a href="#cb2-25"></a>model.add(MaxPooling2D(pool_size<span class="op">=</span>(<span class="dv">3</span>, <span class="dv">3</span>)))</span>
<span id="cb2-26"><a href="#cb2-26"></a></span>
<span id="cb2-27"><a href="#cb2-27"></a>model.add(Dense(units<span class="op">=</span><span class="dv">128</span>, activation<span class="op">=</span><span class="st">"relu"</span>))</span>
<span id="cb2-28"><a href="#cb2-28"></a></span>
<span id="cb2-29"><a href="#cb2-29"></a><span class="cf">with</span> options({<span class="st">"layout_optimizer"</span>: <span class="va">False</span>}):</span>
<span id="cb2-30"><a href="#cb2-30"></a>    model.add(Dropout(<span class="fl">0.2</span>))</span>
<span id="cb2-31"><a href="#cb2-31"></a>model.add(Dense(units<span class="op">=</span><span class="dv">10</span>, activation<span class="op">=</span><span class="st">"softmax"</span>))</span>
<span id="cb2-32"><a href="#cb2-32"></a></span>
<span id="cb2-33"><a href="#cb2-33"></a>model.add(Flatten())</span>
<span id="cb2-34"><a href="#cb2-34"></a>model.add(Dense(units<span class="op">=</span><span class="dv">1</span>, activation<span class="op">=</span><span class="st">"linear"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>I was interested in the effect of dropout, so I used Model B with and without dropout to compare the results. We expect dropout to produce distributions that are more centred around the actual value.</p>
</section>
</section>
<section id="model-a-trained-on-one-density-predicting-the-same-density." class="level3">
<h3 class="anchored" data-anchor-id="model-a-trained-on-one-density-predicting-the-same-density.">Model A trained on one density, predicting the same density.</h3>
<div id="3253b3eb" class="cell" data-execution_count="5">
<div class="cell-output cell-output-stdout">
<pre><code>Number of unique alpha:  10
Shape of x:  (10000, 128, 128, 1)
Shape of y:  (10000,)
Size of training data:  8000
Size of validation data:  2000</code></pre>
</div>
</div>
<div id="bbf28687" class="cell" data-execution_count="7">
<div class="cell-output cell-output-stdout">
<pre><code>1.0
0.04027245
0.08436323
0.051214695
0.8800811375901546</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="week_15_files/figure-html/cell-5-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="model-b-trained-on-one-density-predicting-the-same-density" class="level3">
<h3 class="anchored" data-anchor-id="model-b-trained-on-one-density-predicting-the-same-density">Model B, trained on one density, predicting the same density</h3>
<div id="81635602" class="cell" data-execution_count="8">
<div class="cell-output cell-output-stdout">
<pre><code>Collected:  11020
1.0
0.0036920607
0.0717594
0.032156073
0.9376105985517396</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="week_15_files/figure-html/cell-6-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="model-b-without-dropout-layer-trained-on-one-density-predicting-the-same-density" class="level3">
<h3 class="anchored" data-anchor-id="model-b-without-dropout-layer-trained-on-one-density-predicting-the-same-density">Model B, without dropout layer, trained on one density, predicting the same density</h3>
<div id="8b26f272" class="cell" data-execution_count="9">
<div class="cell-output cell-output-stdout">
<pre><code>Collected:  12148
1.0
0.01220879
0.0647896
0.03377225
0.9100308053552608</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="week_15_files/figure-html/cell-7-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="predicting-novel-densities" class="level3">
<h3 class="anchored" data-anchor-id="predicting-novel-densities">Predicting novel densities</h3>
<p>We previously trained on <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ϕ</mi><mo>=</mo><mn>0.15</mn></mrow><annotation encoding="application/x-tex">\phi = 0.15</annotation></semantics></math> and try to predict the validation set also for the same <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>ϕ</mi><annotation encoding="application/x-tex">\phi</annotation></semantics></math>. What happens if we try and predict it on a different value for <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>ϕ</mi><annotation encoding="application/x-tex">\phi</annotation></semantics></math>? We expect it to still be somewhat accurate for a slightly different value, but not perform at all for very different value.</p>
<p>We think this is because there are thresholds for <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>ϕ</mi><annotation encoding="application/x-tex">\phi</annotation></semantics></math> where the behaviour of cluster changes, they can consistently enter percolation regime (for high <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>ϕ</mi><annotation encoding="application/x-tex">\phi</annotation></semantics></math>) and can have extremely big cluster sizes (also for high <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>ϕ</mi><annotation encoding="application/x-tex">\phi</annotation></semantics></math>). This would present to the network novel situations not seen at <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ϕ</mi><mo>=</mo><mn>0.15</mn></mrow><annotation encoding="application/x-tex">\phi = 0.15</annotation></semantics></math>, where we don’t expect percolation as it is very unlikely.</p>
<p>We use <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ϕ</mi><mo>=</mo><mn>0.25</mn></mrow><annotation encoding="application/x-tex">\phi = 0.25</annotation></semantics></math> for the “slightly” different density and <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ϕ</mi><mo>=</mo><mn>0.45</mn></mrow><annotation encoding="application/x-tex">\phi = 0.45</annotation></semantics></math> for the “very” different density. As of now we don’t have a metric to evaluate our model (this is planned for next week), so comparisons are done qualitatively.</p>
</section>
<section id="model-a-on-phi0.25" class="level3">
<h3 class="anchored" data-anchor-id="model-a-on-phi0.25">Model A on <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ϕ</mi><mo>=</mo><mn>0.25</mn></mrow><annotation encoding="application/x-tex">\phi=0.25</annotation></semantics></math></h3>
<div id="26b2b319" class="cell" data-execution_count="10">
<div class="cell-output cell-output-stdout">
<pre><code>Collected:  13435
Number of unique alpha:  10
Shape of x:  (10000, 128, 128, 1)
Shape of y:  (10000,)
Size of training data:  8000
Size of validation data:  2000</code></pre>
</div>
</div>
<div id="fe04c6b4" class="cell" data-execution_count="11">
<div class="cell-output cell-output-stdout">
<pre><code>0.9
0.056310352
0.09474326
0.07733949
0.7240413106786887</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="week_15_files/figure-html/cell-9-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="model-b-on-phi0.25" class="level3">
<h3 class="anchored" data-anchor-id="model-b-on-phi0.25">Model B on <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ϕ</mi><mo>=</mo><mn>0.25</mn></mrow><annotation encoding="application/x-tex">\phi=0.25</annotation></semantics></math></h3>
<div id="9de34bda" class="cell" data-execution_count="12">
<div class="cell-output cell-output-stdout">
<pre><code>Collected:  12509
1.0
0.0038437229
0.07215052
0.032901235
0.9577752110859448</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="week_15_files/figure-html/cell-10-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="model-b-without-dropout-layer-on-phi0.25" class="level3">
<h3 class="anchored" data-anchor-id="model-b-without-dropout-layer-on-phi0.25">Model B, without dropout layer, on <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ϕ</mi><mo>=</mo><mn>0.25</mn></mrow><annotation encoding="application/x-tex">\phi=0.25</annotation></semantics></math></h3>
<div id="16328b7c" class="cell" data-execution_count="13">
<div class="cell-output cell-output-stdout">
<pre><code>Collected:  11280
1.0
0.013498955
0.08504163
0.042217374
0.9397948348732196</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="week_15_files/figure-html/cell-11-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="model-a-on-phi0.45" class="level3">
<h3 class="anchored" data-anchor-id="model-a-on-phi0.45">Model A on <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ϕ</mi><mo>=</mo><mn>0.45</mn></mrow><annotation encoding="application/x-tex">\phi=0.45</annotation></semantics></math></h3>
<div id="1cbf8fc1" class="cell" data-execution_count="14">
<div class="cell-output cell-output-stdout">
<pre><code>Collected:  13630
Number of unique alpha:  10
Shape of x:  (10000, 128, 128, 1)
Shape of y:  (10000,)
Size of training data:  8000
Size of validation data:  2000</code></pre>
</div>
</div>
<div id="019fcb66" class="cell" data-execution_count="15">
<div class="cell-output cell-output-stdout">
<pre><code>0.2
0.06198603
0.089977786
0.07721992
0.3369544604797045</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="week_15_files/figure-html/cell-13-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="model-b-on-phi0.45" class="level3">
<h3 class="anchored" data-anchor-id="model-b-on-phi0.45">Model B on <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ϕ</mi><mo>=</mo><mn>0.45</mn></mrow><annotation encoding="application/x-tex">\phi=0.45</annotation></semantics></math></h3>
<div id="5f352af0" class="cell" data-execution_count="16">
<div class="cell-output cell-output-stdout">
<pre><code>Collected:  12664
0.0
0.0032266236
0.052909803
0.015262815
0.9224203064863151</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="week_15_files/figure-html/cell-14-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="model-b-without-dropout-layer-on-phi0.45" class="level3">
<h3 class="anchored" data-anchor-id="model-b-without-dropout-layer-on-phi0.45">Model B, without dropout layer, on <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ϕ</mi><mo>=</mo><mn>0.45</mn></mrow><annotation encoding="application/x-tex">\phi=0.45</annotation></semantics></math></h3>
<div id="c56d0788" class="cell" data-execution_count="17">
<div class="cell-output cell-output-stdout">
<pre><code>Collected:  10330
1.0
0.013544914
0.06589952
0.02933981
0.9244929021652859</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="week_15_files/figure-html/cell-15-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="comparing-model-a-to-model-b" class="level3">
<h3 class="anchored" data-anchor-id="comparing-model-a-to-model-b">Comparing Model A to Model B</h3>
<ul>
<li>Both seem to exhibit correlation to the actual values.</li>
<li>Model A has significantly more spread than Model B</li>
<li>Dropout doesn’t reduce spread but make the average of each <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>α</mi><annotation encoding="application/x-tex">\alpha</annotation></semantics></math> less centred around the actual value.</li>
<li>Dropout adds a lot of spread to the first <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>α</mi><annotation encoding="application/x-tex">\alpha</annotation></semantics></math>.</li>
<li>Model A performs poorly on <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ϕ</mi><mo>≠</mo><mn>0.15</mn></mrow><annotation encoding="application/x-tex">\phi \neq 0.15</annotation></semantics></math> (which it was trained on).</li>
<li>Model B performs poorly only on <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ϕ</mi><mo>=</mo><mn>0.45</mn></mrow><annotation encoding="application/x-tex">\phi = 0.45</annotation></semantics></math> (it does well on <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ϕ</mi><mo>=</mo><mn>0.25</mn></mrow><annotation encoding="application/x-tex">\phi = 0.25</annotation></semantics></math>)</li>
<li>But turning off dropout for B makes it perform better on <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ϕ</mi><mo>=</mo><mn>0.45</mn></mrow><annotation encoding="application/x-tex">\phi = 0.45</annotation></semantics></math>.</li>
</ul>
<p>Dropout seems to reduce overfit by a lot. I don’t know if setting it to 0.2 here is too much dropout. In the next iteration of the network, I think we can work with 0.1.</p>


</section>
</section>
<section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes">
<hr>
<ol>
<li id="fn1"><p>See also <a href="https://pyimagesearch.com/2019/01/28/keras-regression-and-cnns/">House price regression 1</a>, <a href="https://machinelearningmastery.com/regression-tutorial-keras-deep-learning-library-python/">House price regression 2</a>, <a href="https://www.tensorflow.org/tutorials/keras/regression">TF Regression tutorial</a>, <a href="https://stats.stackexchange.com/questions/335836/cnn-architectures-for-regression">StackOverflow</a>, <a href="https://datascience.stackexchange.com/questions/26969/how-to-make-a-cnn-predict-a-continuous-value">StackOverflow 2</a>, <a href="https://www.tensorflow.org/tutorials/keras/regression">TDS pytorch on CNN to predict a continuous property</a>, <a href="https://www.datatechnotes.com/2019/12/how-to-fit-regression-data-with-cnn.html">CNN with regression</a>.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/mstcl\.github\.io\/msci-wiki\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




<script src="../site_libs/quarto-html/zenscroll-min.js"></script>
</body></html>